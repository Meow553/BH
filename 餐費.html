<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ± é¤è²»ç´€éŒ„ç³»çµ±</title>
    <link rel="icon" href="https://i.postimg.cc/59gfq2j7/1-removebg-preview.png" type="image/png">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .logo img {
            height: 40px;
            margin-right: 10px;
        }
        .login-form, .admin-form, .record-form, .student-form {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        button {
            padding: 8px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.logout {
            background-color: #f44336;
        }
        button.logout:hover {
            background-color: #d32f2f;
        }
        button.secondary {
            background-color: #2196F3;
        }
        button.secondary:hover {
            background-color: #0b7dda;
        }
        input, select {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        .paid {
            background-color: #dff0d8;
        }
        .unpaid {
            background-color: #fcf8e3;
        }
        .error {
            color: red;
            font-size: 14px;
        }
        .success {
            color: green;
            font-size: 14px;
        }
        .month-selector {
            margin-bottom: 20px;
        }
        .hidden {
            display: none;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #eee;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background-color: #ddd;
            font-weight: bold;
        }
        .stats {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .stats h3 {
            margin-top: 0;
        }
        .stats p {
            margin: 5px 0;
            font-size: 16px;
        }
        .total-amount {
            font-weight: bold;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <img src="https://i.postimg.cc/59gfq2j7/1-removebg-preview.png" alt="é¤è²»ç³»çµ±Logo">
                <span>é¤è²»ç´€éŒ„ç³»çµ±</span>
            </div>
            <button id="logoutBtn" class="logout hidden">ç™»å‡º</button>
        </div>

        <!-- ç™»å…¥å€å¡Š -->
        <div id="loginSection">
            <div class="login-form">
                <h2>ç™»å…¥</h2>
                <div id="loginError" class="error"></div>
                <input type="text" id="username" placeholder="å¸³è™Ÿ" required>
                <input type="password" id="password" placeholder="å¯†ç¢¼ (4ä½æ•¸å­—ä»¥ä¸Š)" required>
                <button id="loginBtn">ç™»å…¥</button>
            </div>
        </div>

        <!-- ä¸»åŠŸèƒ½å€å¡Š (ç™»å…¥å¾Œé¡¯ç¤º) -->
        <div id="mainSection" class="hidden">
            <div class="tabs">
                <div class="tab active" data-tab="records">é¤è²»ç´€éŒ„</div>
                <div class="tab" data-tab="students">å­¸ç”Ÿç®¡ç†</div>
                <div class="tab" data-tab="admins">ç®¡ç†å“¡è¨­å®š</div>
            </div>

            <!-- é¤è²»ç´€éŒ„é é¢ -->
            <div id="recordsTab" class="tab-content">
                <div class="month-selector">
                    <select id="monthSelect">
                        <option value="0">å…¨éƒ¨æœˆä»½</option>
                    </select>
                </div>

                <div class="stats">
                    <h3>çµ±è¨ˆè³‡è¨Š</h3>
                    <p id="totalRecords">ç¸½ç´€éŒ„æ•¸: 0</p>
                    <p id="totalAmount" class="total-amount">ç¸½é‡‘é¡: $0</p>
                    <p id="totalPaid">å·²ä»˜æ¬¾é‡‘é¡: $0</p>
                    <p id="totalUnpaid">æœªä»˜æ¬¾é‡‘é¡: $0</p>
                </div>

                <div class="record-form">
                    <h3>æ–°å¢é¤è²»ç´€éŒ„</h3>
                    <div id="recordError" class="error"></div>
                    <div id="recordSuccess" class="success"></div>
                    <select id="studentSelect" required>
                        <option value="">é¸æ“‡å­¸ç”Ÿ</option>
                    </select>
                    <input type="date" id="recordDate" required>
                    <input type="number" id="recordAmount" placeholder="é‡‘é¡" required>
                    <button id="addRecordBtn">æ–°å¢ç´€éŒ„</button>
                </div>

                <table id="recordsTable">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>å­¸ç”Ÿå§“å</th>
                            <th>å¹´ç´š</th>
                            <th>é‡‘é¡</th>
                            <th>å¡«å¯«äººå“¡</th>
                            <th>ä»˜æ¬¾ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <!-- ç´€éŒ„å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>

            <!-- å­¸ç”Ÿç®¡ç†é é¢ -->
            <div id="studentsTab" class="tab-content hidden">
                <div class="student-form">
                    <h3>å­¸ç”Ÿç®¡ç†</h3>
                    <div id="studentError" class="error"></div>
                    <div id="studentSuccess" class="success"></div>
                    <input type="text" id="studentName" placeholder="å­¸ç”Ÿå§“å" required>
                    <select id="studentGrade" required>
                        <option value="">é¸æ“‡å¹´ç´š</option>
                        <option value="1">ä¸€å¹´ç´š</option>
                        <option value="2">äºŒå¹´ç´š</option>
                        <option value="3">ä¸‰å¹´ç´š</option>
                        <option value="4">å››å¹´ç´š</option>
                        <option value="5">äº”å¹´ç´š</option>
                        <option value="6">å…­å¹´ç´š</option>
                    </select>
                    <button id="addStudentBtn">æ·»åŠ å­¸ç”Ÿ</button>
                </div>

                <table id="studentsTable">
                    <thead>
                        <tr>
                            <th>å­¸ç”ŸID</th>
                            <th>å­¸ç”Ÿå§“å</th>
                            <th>å¹´ç´š</th>
                            <th>ç¸½é‡‘é¡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="studentsBody">
                        <!-- å­¸ç”Ÿåˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>

            <!-- ç®¡ç†å“¡è¨­å®šé é¢ -->
            <div id="adminsTab" class="tab-content hidden">
                <div class="admin-form">
                    <h3>ç®¡ç†å“¡è¨­å®š</h3>
                    <div id="adminError" class="error"></div>
                    <div id="adminSuccess" class="success"></div>
                    <input type="text" id="adminUsername" placeholder="å¸³è™Ÿ" required>
                    <input type="password" id="adminPassword" placeholder="å¯†ç¢¼ (4ä½æ•¸å­—ä»¥ä¸Š)" required>
                    <button id="addAdminBtn">æ·»åŠ ç®¡ç†å“¡</button>
                </div>

                <table id="adminsTable">
                    <thead>
                        <tr>
                            <th>å¸³è™Ÿ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="adminsBody">
                        <!-- ç®¡ç†å“¡åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–è³‡æ–™
        let currentUser = null;
        let isAdmin = false;
        let refreshInterval;
        
        // å¾localStorageè¼‰å…¥è³‡æ–™æˆ–åˆå§‹åŒ–
        let students = JSON.parse(localStorage.getItem('students')) || [];
        let records = JSON.parse(localStorage.getItem('records')) || [];
        let admins = JSON.parse(localStorage.getItem('admins')) || [
            { username: 'BH19', password: '032188816' }
        ];
        
        // DOMå…ƒç´ 
        const loginSection = document.getElementById('loginSection');
        const mainSection = document.getElementById('mainSection');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginBtn = document.getElementById('loginBtn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('loginError');
        const monthSelect = document.getElementById('monthSelect');
        const studentSelect = document.getElementById('studentSelect');
        const recordDate = document.getElementById('recordDate');
        const recordAmount = document.getElementById('recordAmount');
        const addRecordBtn = document.getElementById('addRecordBtn');
        const recordsBody = document.getElementById('recordsBody');
        const studentName = document.getElementById('studentName');
        const studentGrade = document.getElementById('studentGrade');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const studentsBody = document.getElementById('studentsBody');
        const adminUsername = document.getElementById('adminUsername');
        const adminPassword = document.getElementById('adminPassword');
        const addAdminBtn = document.getElementById('addAdminBtn');
        const adminsBody = document.getElementById('adminsBody');
        const recordError = document.getElementById('recordError');
        const recordSuccess = document.getElementById('recordSuccess');
        const studentError = document.getElementById('studentError');
        const studentSuccess = document.getElementById('studentSuccess');
        const adminError = document.getElementById('adminError');
        const adminSuccess = document.getElementById('adminSuccess');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const totalRecordsEl = document.getElementById('totalRecords');
        const totalAmountEl = document.getElementById('totalAmount');
        const totalPaidEl = document.getElementById('totalPaid');
        const totalUnpaidEl = document.getElementById('totalUnpaid');
        
        // è¨­ç½®ä»Šå¤©ç‚ºé è¨­æ—¥æœŸ
        recordDate.valueAsDate = new Date();
        
        // åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨
        function initMonthSelect() {
            monthSelect.innerHTML = '<option value="0">å…¨éƒ¨æœˆä»½</option>';
            
            // å¾ç´€éŒ„ä¸­æå–æ‰€æœ‰æœˆä»½
            const months = new Set();
            records.forEach(record => {
                const date = new Date(record.date);
                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                months.add(monthYear);
            });
            
            // æ’åºä¸¦æ·»åŠ åˆ°é¸æ“‡å™¨
            Array.from(months).sort().reverse().forEach(month => {
                const [year, monthNum] = month.split('-');
                const option = document.createElement('option');
                option.value = month;
                option.textContent = `${year}å¹´${monthNum}æœˆ`;
                monthSelect.appendChild(option);
            });
        }
        
        // åˆå§‹åŒ–å­¸ç”Ÿé¸æ“‡å™¨
        function initStudentSelect() {
            studentSelect.innerHTML = '<option value="">é¸æ“‡å­¸ç”Ÿ</option>';
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (${student.grade}å¹´ç´š)`;
                studentSelect.appendChild(option);
            });
        }
        
        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats(filterMonth = '0') {
            let filteredRecords = [...records];
            if (filterMonth !== '0') {
                filteredRecords = records.filter(record => {
                    const recordDate = new Date(record.date);
                    const recordMonth = `${recordDate.getFullYear()}-${String(recordDate.getMonth() + 1).padStart(2, '0')}`;
                    return recordMonth === filterMonth;
                });
            }
            
            const totalRecords = filteredRecords.length;
            const totalAmount = filteredRecords.reduce((sum, r) => sum + parseInt(r.amount), 0);
            const totalPaid = filteredRecords.filter(r => r.paid).reduce((sum, r) => sum + parseInt(r.amount), 0);
            const totalUnpaid = totalAmount - totalPaid;
            
            totalRecordsEl.textContent = `ç¸½ç´€éŒ„æ•¸: ${totalRecords}`;
            totalAmountEl.textContent = `ç¸½é‡‘é¡: $${totalAmount}`;
            totalPaidEl.textContent = `å·²ä»˜æ¬¾é‡‘é¡: $${totalPaid}`;
            totalUnpaidEl.textContent = `æœªä»˜æ¬¾é‡‘é¡: $${totalUnpaid}`;
        }
        
        // é¡¯ç¤ºç´€éŒ„
        function displayRecords(filterMonth = '0') {
            recordsBody.innerHTML = '';
            
            let filteredRecords = [...records];
            if (filterMonth !== '0') {
                filteredRecords = records.filter(record => {
                    const recordDate = new Date(record.date);
                    const recordMonth = `${recordDate.getFullYear()}-${String(recordDate.getMonth() + 1).padStart(2, '0')}`;
                    return recordMonth === filterMonth;
                });
            }
            
            // æŒ‰æ—¥æœŸæ’åº (æœ€æ–°çš„åœ¨å‰é¢)
            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            filteredRecords.forEach(record => {
                const student = students.find(s => s.id === record.studentId);
                if (!student) return;
                
                const row = document.createElement('tr');
                row.className = record.paid ? 'paid' : 'unpaid';
                
                const date = new Date(record.date);
                const formattedDate = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${student.name}</td>
                    <td>${student.grade}å¹´ç´š</td>
                    <td>${record.amount}</td>
                    <td>${record.creator}</td>
                    <td>
                        <button class="payment-btn" data-id="${record.id}" ${record.paid ? 'disabled' : ''}>
                            ${record.paid ? 'å·²ä»˜æ¬¾' : 'æœªä»˜æ¬¾'}
                        </button>
                    </td>
                    <td>
                        ${isAdmin ? `<button class="edit-btn" data-id="${record.id}">ç·¨è¼¯</button>
                        <button class="delete-btn" data-id="${record.id}">åˆªé™¤</button>` : ''}
                    </td>
                `;
                
                recordsBody.appendChild(row);
            });
            
            // æ›´æ–°çµ±è¨ˆè³‡è¨Š
            updateStats(filterMonth);
            
            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const recordId = this.getAttribute('data-id');
                    markAsPaid(recordId);
                });
            });
            
            if (isAdmin) {
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const recordId = this.getAttribute('data-id');
                        editRecord(recordId);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const recordId = this.getAttribute('data-id');
                        deleteRecord(recordId);
                    });
                });
            }
        }
        
        // é¡¯ç¤ºå­¸ç”Ÿåˆ—è¡¨
        function displayStudents() {
            studentsBody.innerHTML = '';
            
            students.forEach(student => {
                // è¨ˆç®—å­¸ç”Ÿçš„ç¸½é‡‘é¡
                const totalAmount = records
                    .filter(r => r.studentId === student.id)
                    .reduce((sum, r) => sum + parseInt(r.amount), 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td>${student.grade}å¹´ç´š</td>
                    <td>${totalAmount}</td>
                    <td>
                        ${isAdmin ? `<button class="edit-student-btn" data-id="${student.id}">ç·¨è¼¯</button>
                        <button class="delete-student-btn" data-id="${student.id}">åˆªé™¤</button>` : ''}
                    </td>
                `;
                
                studentsBody.appendChild(row);
            });
            
            if (isAdmin) {
                document.querySelectorAll('.edit-student-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const studentId = this.getAttribute('data-id');
                        editStudent(studentId);
                    });
                });
                
                document.querySelectorAll('.delete-student-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const studentId = this.getAttribute('data-id');
                        deleteStudent(studentId);
                    });
                });
            }
        }
        
        // é¡¯ç¤ºç®¡ç†å“¡åˆ—è¡¨
        function displayAdmins() {
            adminsBody.innerHTML = '';
            
            admins.forEach(admin => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${admin.username}</td>
                    <td>
                        ${admin.username !== 'BH19' ? `<button class="delete-admin-btn" data-username="${admin.username}">åˆªé™¤</button>` : 'ç³»çµ±é è¨­'}
                    </td>
                `;
                
                adminsBody.appendChild(row);
            });
            
            document.querySelectorAll('.delete-admin-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    deleteAdmin(username);
                });
            });
        }
        
        // æ¨™è¨˜ç‚ºå·²ä»˜æ¬¾
        function markAsPaid(recordId) {
            const recordIndex = records.findIndex(r => r.id === recordId);
            if (recordIndex !== -1) {
                records[recordIndex].paid = true;
                localStorage.setItem('records', JSON.stringify(records));
                displayRecords(monthSelect.value);
                recordSuccess.textContent = 'å·²æ¨™è¨˜ç‚ºå·²ä»˜æ¬¾';
                setTimeout(() => recordSuccess.textContent = '', 3000);
            }
        }
        
        // ç·¨è¼¯ç´€éŒ„
        function editRecord(recordId) {
            const record = records.find(r => r.id === recordId);
            if (!record) return;
            
            const student = students.find(s => s.id === record.studentId);
            const currentStudentName = student ? `${student.name} (${student.grade}å¹´ç´š)` : 'æœªçŸ¥å­¸ç”Ÿ';
            
            let newStudentId = record.studentId;
            let newDate = record.date;
            let newAmount = record.amount;
            
            // å‰µå»ºç·¨è¼¯è¡¨å–®
            const form = document.createElement('div');
            form.innerHTML = `
                <h3>ç·¨è¼¯ç´€éŒ„</h3>
                <p>ç•¶å‰å­¸ç”Ÿ: ${currentStudentName}</p>
                <select id="editStudentSelect">
                    <option value="">ä¸è®Šæ›´å­¸ç”Ÿ</option>
                </select>
                <input type="date" id="editRecordDate" value="${newDate}">
                <input type="number" id="editRecordAmount" value="${newAmount}" placeholder="é‡‘é¡">
                <button id="saveEditBtn">ä¿å­˜</button>
                <button id="cancelEditBtn">å–æ¶ˆ</button>
            `;
            
            // å¡«å……å­¸ç”Ÿé¸æ“‡å™¨
            const editStudentSelect = form.querySelector('#editStudentSelect');
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (${student.grade}å¹´ç´š)`;
                editStudentSelect.appendChild(option);
            });
            
            // é¡¯ç¤ºç·¨è¼¯è¡¨å–®
            recordSuccess.innerHTML = '';
            recordSuccess.appendChild(form);
            
            // ä¿å­˜ç·¨è¼¯
            form.querySelector('#saveEditBtn').addEventListener('click', function() {
                const selectedStudentId = editStudentSelect.value;
                const editDate = form.querySelector('#editRecordDate').value;
                const editAmount = form.querySelector('#editRecordAmount').value;
                
                if (editAmount && !/^\d+$/.test(editAmount)) {
                    alert('é‡‘é¡å¿…é ˆæ˜¯æ•¸å­—');
                    return;
                }
                
                if (selectedStudentId) newStudentId = selectedStudentId;
                if (editDate) newDate = editDate;
                if (editAmount) newAmount = parseInt(editAmount);
                
                record.studentId = newStudentId;
                record.date = newDate;
                record.amount = newAmount;
                localStorage.setItem('records', JSON.stringify(records));
                
                // é‡æ–°åˆå§‹åŒ–å­¸ç”Ÿé¸æ“‡å™¨å’Œæœˆä»½é¸æ“‡å™¨
                initStudentSelect();
                initMonthSelect();
                
                // æ›´æ–°é¡¯ç¤º
                displayRecords(monthSelect.value);
                recordSuccess.textContent = 'ç´€éŒ„å·²æ›´æ–°';
                setTimeout(() => recordSuccess.textContent = '', 3000);
            });
            
            // å–æ¶ˆç·¨è¼¯
            form.querySelector('#cancelEditBtn').addEventListener('click', function() {
                recordSuccess.textContent = '';
            });
        }
        
        // ç·¨è¼¯å­¸ç”Ÿ
        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const newName = prompt("è¼¸å…¥æ–°å§“å:", student.name);
            if (newName === null) return;
            
            const newGrade = prompt("è¼¸å…¥æ–°å¹´ç´š (1-6):", student.grade);
            if (newGrade === null) return;
            
            if (newName && newGrade && /^[1-6]$/.test(newGrade)) {
                student.name = newName;
                student.grade = parseInt(newGrade);
                localStorage.setItem('students', JSON.stringify(students));
                
                // æ›´æ–°é¡¯ç¤º
                initStudentSelect();
                displayStudents();
                displayRecords(monthSelect.value);
                
                studentSuccess.textContent = 'å­¸ç”Ÿè³‡æ–™å·²æ›´æ–°';
                setTimeout(() => studentSuccess.textContent = '', 3000);
            } else {
                studentError.textContent = 'è¼¸å…¥ç„¡æ•ˆï¼Œå§“åä¸èƒ½ç‚ºç©ºä¸”å¹´ç´šå¿…é ˆæ˜¯1-6';
                setTimeout(() => studentError.textContent = '', 3000);
            }
        }
        
        // åˆªé™¤ç´€éŒ„
        function deleteRecord(recordId) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç´€éŒ„å—ï¼Ÿ')) {
                records = records.filter(r => r.id !== recordId);
                localStorage.setItem('records', JSON.stringify(records));
                displayRecords(monthSelect.value);
                recordSuccess.textContent = 'ç´€éŒ„å·²åˆªé™¤';
                setTimeout(() => recordSuccess.textContent = '', 3000);
            }
        }
        
        // æ·»åŠ ç´€éŒ„
        function addRecord() {
            const studentId = studentSelect.value;
            const date = recordDate.value;
            const amount = recordAmount.value;
            
            if (!studentId || !date || !amount) {
                recordError.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½';
                return;
            }
            
            if (!/^\d+$/.test(amount)) {
                recordError.textContent = 'é‡‘é¡å¿…é ˆæ˜¯æ•¸å­—';
                return;
            }
            
            const newRecord = {
                id: Date.now().toString(),
                studentId,
                date,
                amount: parseInt(amount),
                creator: currentUser,
                paid: false
            };
            
            records.push(newRecord);
            localStorage.setItem('records', JSON.stringify(records));
            
            // æ¸…ç©ºè¡¨å–®
            recordAmount.value = '';
            recordError.textContent = '';
            recordSuccess.textContent = 'ç´€éŒ„å·²æ·»åŠ ';
            setTimeout(() => recordSuccess.textContent = '', 3000);
            
            // æ›´æ–°é¡¯ç¤º
            initMonthSelect();
            displayRecords(monthSelect.value);
        }
        
        // æ·»åŠ å­¸ç”Ÿ
        function addStudent() {
            const name = studentName.value.trim();
            const grade = studentGrade.value;
            
            if (!name || !grade) {
                studentError.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½';
                return;
            }
            
            if (!isAdmin) {
                studentError.textContent = 'åªæœ‰ç®¡ç†å“¡å¯ä»¥æ·»åŠ å­¸ç”Ÿ';
                return;
            }
            
            const newStudent = {
                id: Date.now().toString(),
                name,
                grade: parseInt(grade)
            };
            
            students.push(newStudent);
            localStorage.setItem('students', JSON.stringify(students));
            
            // æ¸…ç©ºè¡¨å–®
            studentName.value = '';
            studentGrade.value = '';
            studentError.textContent = '';
            studentSuccess.textContent = 'å­¸ç”Ÿå·²æ·»åŠ ';
            setTimeout(() => studentSuccess.textContent = '', 3000);
            
            // æ›´æ–°é¡¯ç¤º
            initStudentSelect();
            displayStudents();
        }
        
        // åˆªé™¤å­¸ç”Ÿ
        function deleteStudent(studentId) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å­¸ç”Ÿå—ï¼Ÿç›¸é—œç´€éŒ„å°‡ä¿ç•™ä½†ä¸å†é¡¯ç¤ºå­¸ç”Ÿå§“åã€‚')) {
                students = students.filter(s => s.id !== studentId);
                localStorage.setItem('students', JSON.stringify(students));
                
                // æ›´æ–°é¡¯ç¤º
                initStudentSelect();
                displayStudents();
                displayRecords(monthSelect.value);
                
                studentSuccess.textContent = 'å­¸ç”Ÿå·²åˆªé™¤';
                setTimeout(() => studentSuccess.textContent = '', 3000);
            }
        }
        
        // æ·»åŠ ç®¡ç†å“¡
        function addAdmin() {
            const username = adminUsername.value.trim();
            const password = adminPassword.value;
            
            if (!username || !password) {
                adminError.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½';
                return;
            }
            
            if (!isAdmin) {
                adminError.textContent = 'åªæœ‰ç®¡ç†å“¡å¯ä»¥æ·»åŠ ç®¡ç†å“¡';
                return;
            }
            
            if (!/^\d{4,}$/.test(password)) {
                adminError.textContent = 'å¯†ç¢¼å¿…é ˆæ˜¯4ä½æ•¸å­—ä»¥ä¸Š';
                return;
            }
            
            if (admins.some(a => a.username === username)) {
                adminError.textContent = 'æ­¤å¸³è™Ÿå·²å­˜åœ¨';
                return;
            }
            
            const newAdmin = {
                username,
                password
            };
            
            admins.push(newAdmin);
            localStorage.setItem('admins', JSON.stringify(admins));
            
            // æ¸…ç©ºè¡¨å–®
            adminUsername.value = '';
            adminPassword.value = '';
            adminError.textContent = '';
            adminSuccess.textContent = 'ç®¡ç†å“¡å·²æ·»åŠ ';
            setTimeout(() => adminSuccess.textContent = '', 3000);
            
            // æ›´æ–°é¡¯ç¤º
            displayAdmins();
        }
        
        // åˆªé™¤ç®¡ç†å“¡
        function deleteAdmin(username) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç®¡ç†å“¡ ${username} å—ï¼Ÿ`)) {
                admins = admins.filter(a => a.username !== username);
                localStorage.setItem('admins', JSON.stringify(admins));
                displayAdmins();
                adminSuccess.textContent = 'ç®¡ç†å“¡å·²åˆªé™¤';
                setTimeout(() => adminSuccess.textContent = '', 3000);
            }
        }
        
        // è‡ªå‹•åˆ·æ–°æ•¸æ“š
        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => {
                displayRecords(monthSelect.value);
                displayStudents();
                displayAdmins();
            }, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
        }
        
        // åœæ­¢è‡ªå‹•åˆ·æ–°
        function stopAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
        }
        
        // ç™»å…¥
        function login() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            
            if (!username || !password) {
                loginError.textContent = 'è«‹å¡«å¯«å¸³è™Ÿå’Œå¯†ç¢¼';
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å“¡
            const admin = admins.find(a => a.username === username && a.password === password);
            
            if (admin) {
                currentUser = username;
                isAdmin = true;
                loginSection.classList.add('hidden');
                mainSection.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                
                // åˆå§‹åŒ–æ•¸æ“šé¡¯ç¤º
                initMonthSelect();
                initStudentSelect();
                displayRecords();
                displayStudents();
                displayAdmins();
                
                // é–‹å§‹è‡ªå‹•åˆ·æ–°
                startAutoRefresh();
            } else {
                // å¦‚æœä¸æ˜¯ç®¡ç†å“¡ï¼Œä¹Ÿå¯ä»¥ä½œç‚ºæ™®é€šç”¨æˆ¶ç™»å…¥
                currentUser = username;
                isAdmin = false;
                loginSection.classList.add('hidden');
                mainSection.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                
                // åˆå§‹åŒ–æ•¸æ“šé¡¯ç¤º
                initMonthSelect();
                initStudentSelect();
                displayRecords();
                displayStudents();
                displayAdmins();
                
                // æ™®é€šç”¨æˆ¶ä¸èƒ½çœ‹åˆ°ç®¡ç†å“¡é¸é …
                document.querySelector('.tab[data-tab="admins"]').classList.add('hidden');
                
                // é–‹å§‹è‡ªå‹•åˆ·æ–°
                startAutoRefresh();
            }
        }
        
        // ç™»å‡º
        function logout() {
            currentUser = null;
            isAdmin = false;
            loginSection.classList.remove('hidden');
            mainSection.classList.add('hidden');
            logoutBtn.classList.add('hidden');
            usernameInput.value = '';
            passwordInput.value = '';
            loginError.textContent = '';
            
            // é‡ç½®é¸é …å¡
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.add('hidden'));
            tabs[0].classList.add('active');
            tabContents[0].classList.remove('hidden');
            
            // é¡¯ç¤ºæ‰€æœ‰é¸é …å¡ (ç®¡ç†å“¡é¸é …å¯èƒ½è¢«éš±è—)
            document.querySelector('.tab[data-tab="admins"]').classList.remove('hidden');
            
            // åœæ­¢è‡ªå‹•åˆ·æ–°
            stopAutoRefresh();
        }
        
        // äº‹ä»¶ç›£è½å™¨
        loginBtn.addEventListener('click', login);
        logoutBtn.addEventListener('click', logout);
        addRecordBtn.addEventListener('click', addRecord);
        addStudentBtn.addEventListener('click', addStudent);
        addAdminBtn.addEventListener('click', addAdmin);
        
        // æŒ‰Enteréµç™»å…¥
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
        
        // æœˆä»½é¸æ“‡å™¨è®ŠåŒ–
        monthSelect.addEventListener('change', function() {
            displayRecords(this.value);
        });
        
        // é¸é …å¡åˆ‡æ›
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // æ›´æ–°é¸é …å¡ç‹€æ…‹
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // æ›´æ–°å…§å®¹é¡¯ç¤º
                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(`${tabName}Tab`).classList.remove('hidden');
            });
        });
    </script>
</body>
</html>